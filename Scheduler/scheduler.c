/*******************************************************************************
 *  FILE DESCRIPTION
 *  ----------------------------------------------------------------------------
 * Module:
 *
 * File Name: scheduler.c
 *
 * Created on: Nov 24, 2023
 *
 * Description: Source file for the Scheduler
 *
 * Author: Ahmed El-Abbasy
 *
 *******************************************************************************/

/*******************************************************************************
 *                      Includes                                               *
 *******************************************************************************/
#include "scheduler.h"

/*******************************************************************************
 *                      Local Data                                             *
 *******************************************************************************/
task_t tasks[3];
/*******************************************************************************
 *                      Global Data                                            *
 *******************************************************************************/

 /*******************************************************************************
 *                      ISR's Definitions                                      *
 *******************************************************************************/

/*******************************************************************************
 *                      Private Functions Prototypes                           *
 *******************************************************************************/

/*******************************************************************************
 *                      Private Functions Definitions                          *
 *******************************************************************************/

/*******************************************************************************
 *                      Global Functions Definitions                           *
 *******************************************************************************/
/********************************************************************************/
void sch_init()
{
	Timer0_Init();
	timer0_SetCallback(&detect_time);
}
/********************************************************************************/
void sch_createTask(u8 First_Delay,u8 periority_task,u16 numper, void (*fPtr)(void))
{
//	static u8 numberTask =0;
	for(u8 i =0; i<3 ;i++)
	{
		if(tasks[i].task == NULL)
		{
			tasks[i].task = fPtr;
			tasks[i].periodicity_t = numper;
			tasks[i].first_delay = First_Delay;
			tasks[i].statetask = ready;
			break;
		}
	}
	task_t temp;
	for(u8 j =0;j<3 ;j++)
	{
		for(u8 j_1 =0;j_1<3-j ;j_1++)
		{
			if(tasks[j_1].periority > tasks[j_1+1].periority)
			{
				temp = tasks[j_1];
				tasks[j_1]= tasks[j_1+1];
				 tasks[j_1+1] = temp;
			}
		}
	}
}
/********************************************************************************/
void sch_8start()
{
	TCNT0_Reg =48;
	Timer0_Start();
}
void sch_Handler()
{
	static u32 HandlerCounter =1;
	for(u8 i =0 ; i<3 ;i++)
	{
		if(tasks[i].statetask == ready)
		{
			if(((HandlerCounter % (tasks[i].periodicity_t))-tasks[i].first_delay) == 0)
			{
				if((tasks[i].task) !=NULL)
				{
					tasks[i].statetask=running;
					tasks[i].task();
					tasks[i].statetask=ready;
				}
			}
		}
	}
	HandlerCounter++;
}
/********************************************************************************/
void detect_time(void)
{
	static u8 count_tim0 =0;

	count_tim0++;
	if(count_tim0 == 7)
	{
		TCNT0_Reg =48;
		sch_Handler();
		count_tim0 = 0;
	}

}
/********************************************************************************/
void sch_suspend_task(void (*fPtr)(void))
{
	for(u8 i =0 ; i<3 ;i++)
	{
		if(fPtr == tasks[i].task)
		{
			tasks[i].statetask =wait;
		}
	}
}
/********************************************************************************/
void sch_resume_task(void (*fPtr)(void))
{
	for(u8 i =0 ; i<3 ;i++)
	{
		if(fPtr == tasks[i].task)
		{
			tasks[i].statetask =ready;
		}
	}
}
/********************************************************************************/
void sch_delete_task(void (*fPtr)(void))
{
	for(u8 i =0 ; i<3 ;i++)
	{
		if(fPtr == tasks[i].task)
		{
			tasks[i].task = NULL;
			tasks[i].periority =5;
		}
	}
}
/********************************************************************************/

/*******************************************************************************
 *                      End of File: scheduler.c                                        *
 *******************************************************************************/






